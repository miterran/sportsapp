{"version":3,"sources":["../../../src/services/updateBetOrders/index.js"],"names":["updateBetOrderResult","console","log","find","isClosed","status","populate","path","select","betOrders","isEmpty","betOrder","allPicksPending","every","Picks","update","findOneAndUpdate","_id","$set","merge","updatedAt","new","updatedBetOrder","create","title","content"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AAEA;AACA;;AAEA,IAAMA;AAAA,oEAAuB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAC5B;AACAC,cAAQC,GAAR,CAAY,yBAAZ;AAF4B;AAAA;AAAA,aAKH,mBAASC,IAAT,CAAc,EAAEC,UAAU,KAAZ,EAAmBC,QAAQ,SAA3B,EAAd,EAAsD,wBAAtD,EACvBC,QADuB,CACd,EAAEC,MAAM,OAAR,EAAiBC,QAAQ,uBAAzB,EADc,CALG;;AAAA;AAKrBC,eALqB;;AAAA,WAQxB,iBAAEC,OAAF,CAAUD,SAAV,CARwB;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBAUNA,SAVM;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAUlBE,cAVkB;AAWtBC,qBAXsB,GAWJ,iBAAEC,KAAF,CAAQF,SAASG,KAAjB,EAAwB,EAAET,QAAQ,SAAV,EAAxB,CAXI;;AAAA,WAYvBO,eAZuB;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAatBG,YAbsB,GAab,8BAAeJ,QAAf,CAba;;AAAA,YAcvBI,OAAOV,MAAP,KAAkB,SAdK;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA,aAgBE,mBAASW,gBAAT,CAA0B,EAAEC,KAAKN,SAASM,GAAhB,EAA1B,EAAiD,EAAEC,MAAM,iBAAEC,KAAF,CAAQJ,MAAR,EAAgB,EAAEK,WAAW,uBAAb,EAAhB,CAAR,EAAjD,EAAqG,EAAEC,KAAK,IAAP,EAArG,EAAoHf,QAApH,CAA6H,OAA7H,EAAsIA,QAAtI,CAA+I,QAA/I,CAhBF;;AAAA;AAgBtBgB,qBAhBsB;;AAAA,YAkBvBA,gBAAgBjB,MAAhB,KAA2B,QAlBJ;AAAA;AAAA;AAAA;;AAAA;AAAA,aAmBnB,oBAAUkB,MAAV,CAAiB,EAAEC,OAAO,qBAAT,EAAgCC,cAAYH,gBAAgBL,GAA5D,EAAmEZ,QAAQ,QAA3E,EAAjB,CAnBmB;;AAAA;AAAA,UAuBtBiB,gBAAgBlB,QAvBM;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,aAuFrB,oBAAUmB,MAAV,CAAiB,EAAEC,OAAO,gCAAT,EAA2CC,yBAA3C,EAA4DpB,QAAQ,QAApE,EAAjB,CAvFqB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAAvB;;AAAA;AAAA;AAAA;AAAA,GAAN;;kBA2FeL,oB","file":"index.js","sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\nimport BetOrder from '../../models/BetOrder';\nimport Player from '../../models/User.Player';\nimport Agent from '../../models/User.Agent';\nimport SystemLog from '../../models/SystemLog';\nimport settleBetOrder from '../../utils/functions/settleBetOrder';\nimport config from '../../config'\n\n// import apnProvider from '../../apn'\n// import apn from 'apn'\n\nconst updateBetOrderResult = async () => {\n\t// eslint-disable-next-line\n\tconsole.log('update bet order result')\n\ttry {\n\t\t\n\t\tconst betOrders = await BetOrder.find({ isClosed: false, status: 'Pending' }, 'Player Agent bet Picks')\n\t\t.populate({ path: 'Picks', select: 'status marked.oddLine' });\n\n\t\tif(_.isEmpty(betOrders)) return;\n\n\t\tfor( let betOrder of betOrders ){\n\t\t\tlet allPicksPending = _.every(betOrder.Picks, { status: 'Pending' });\n\t\t\tif(allPicksPending) continue;\n\t\t\tlet update = settleBetOrder(betOrder);\n\t\t\tif(update.status === 'Pending') continue;\n\t\t\t\n\t\t\tlet updatedBetOrder = await BetOrder.findOneAndUpdate({ _id: betOrder._id }, { $set: _.merge(update, { updatedAt: moment() }) }, { new: true }).populate('Agent').populate('Player');\n\n\t\t\tif(updatedBetOrder.status === 'Review'){\n\t\t\t\tawait SystemLog.create({ title: 'BetOrder has Review', content: `${updatedBetOrder._id}`, status: 'danger'});\n\t\t\t}\n\n\n\t\t\tif(!updatedBetOrder.isClosed) continue;\n\n\t\t\t// const player = await Player.findOneAndUpdate({ _id: updatedBetOrder.Player }, {\n\t\t\t// \t'$inc': {\n\t\t\t// \t\t'credit.balance': Number(updatedBetOrder.resultAmount),\n\t\t\t// \t\t'credit.pending': -Number(updatedBetOrder.bet.atRisk),\n\t\t\t// \t},\n\t\t\t// \t'$set': {\n\t\t\t// \t\t'credit.updatedAt': moment()\n\t\t\t// \t}\n\t\t\t// });\n\t\t\t\n\t\t\t// const agent = await Agent.findOneAndUpdate({ _id: updatedBetOrder.Agent }, {\n\t\t\t// \t'$inc': {\n\t\t\t// \t\t'credit.balance': updatedBetOrder.status === 'Lost' ? Number(updatedBetOrder.resultAmount) : 0,\n\t\t\t// \t\t'credit.pending': -Number(updatedBetOrder.bet.atRisk)\n\t\t\t// \t},\n\t\t\t// \t'$set': {\n\t\t\t// \t\t'credit.updatedAt': moment()\n\t\t\t// \t}\n\t\t\t// }, {\n\t\t\t// \tnew: true\n\t\t\t// });\n\n\t\t\t// if(updatedBetOrder.status === 'Lost'){\n\t\t\t// \tawait Transaction.create({ \n\t\t\t// \t\tAgent: agent._id,\n\t\t\t// \t\tID: updatedBetOrder.ID,\n\t\t\t// \t\ttype: 'BetOrder',\n\t\t\t// \t\tdescription: `(${player.username}) Lost a ${updatedBetOrder.title}`,\n\t\t\t// \t\tamount: Number(updatedBetOrder.resultAmount),\n\t\t\t// \t\tbalance: agent.credit.balance\n\t\t\t// \t});\n\t\t\t// }\n\n\n\t\t\t// if(updatedBetOrder.Agent.notification.afterBetOrder){\n\t\t\t// \tconst agentNotify = new apn.Notification({\n\t\t\t// \t\tsound: 'ping.aiff',\n\t\t\t// \t\talert: `${updatedBetOrder.Player.username}'s ${updatedBetOrder.title} had ${updatedBetOrder.status} ${updatedBetOrder.resultAmount === 0 ? '' : updatedBetOrder.resultAmount}`,\n\t\t\t// \t\ttopic: config.APN_TOPIC,\n\t\t\t// \t\tpayload: { BetOrder: updatedBetOrder.BetOrder }\n\t\t\t// \t})\n\t\t\t// \tawait apnProvider.send(agentNotify, updatedBetOrder.Agent.notification.deviceToken)\n\t\t\t// }\n\n\t\t\t// if(updatedBetOrder.Player.notification.afterBetOrder){\n\t\t\t// \tconst playerNotify = new apn.Notification({\n\t\t\t// \t\tsound: 'ping.aiff',\n\t\t\t// \t\talert: `Your ${updatedBetOrder.title} had ${updatedBetOrder.status} ${updatedBetOrder.resultAmount === 0 ? '' : updatedBetOrder.resultAmount}`,\n\t\t\t// \t\ttopic: config.APN_TOPIC,\n\t\t\t// \t\tpayload: { BetOrder: updatedBetOrder.BetOrder }\n\t\t\t// \t})\n\t\t\t// \tawait apnProvider.send(playerNotify, updatedBetOrder.Player.notification.deviceToken)\n\t\t\t// }\n\n\n\t\t\t// apnProvider.shutdown();\n\n\n\n\t\t}\n\n\t} catch (e) {\n\t\tawait SystemLog.create({ title: 'update bet order result failed', content: `${e}`, status: 'danger'});\n\t}\n};\n\nexport default updateBetOrderResult;\n"]}