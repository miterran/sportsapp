{"version":3,"sources":["../../../src/services/updatePicks/index.js"],"names":["updatePickResult","console","log","find","isClosed","populate","path","select","then","compact","picks","map","pick","Event","isFinished","isEmpty","eventStatus","status","score","homeScore","home","awayScore","away","pickStatus","findOneAndUpdate","_id","Types","ObjectId","$set","updatedAt","new","updatedPick","create","title","content"],"mappings":";;;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AACA;AACA;;;AAGA,IAAMA;AAAA,oEAAmB;AAAA;;AAAA;AAAA;AAAA;AAAA;AACxB;AACAC,cAAQC,GAAR,CAAY,oBAAZ;AAFwB;AAAA;AAAA,aAIH,eAAKC,IAAL,CAAU,EAAEC,UAAU,KAAZ,EAAV,EAA+B,cAA/B,EAClBC,QADkB,CACT,EAAEC,MAAM,OAAR,EAAiBC,QAAQ,+BAAzB,EADS,EAElBC,IAFkB,CAEb;AAAA,cAAS,iBAAEC,OAAF,CAAUC,MAAMC,GAAN,CAAU;AAAA,eAAQC,KAAKC,KAAL,CAAWC,UAAX,GAAwBF,IAAxB,GAA+B,IAAvC;AAAA,QAAV,CAAV,CAAT;AAAA,OAFa,CAJG;;AAAA;AAIjBF,WAJiB;;AAAA,WAQnB,iBAAEK,OAAF,CAAUL,KAAV,CARmB;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBAUNA,KAVM;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAUdE,UAVc;AAAA,oBAW+DA,IAX/D,CAWhBC,KAXgB,EAWCG,WAXD,eAWPC,MAXO,kCAWcC,KAXd,EAW6BC,SAX7B,qBAWuBC,IAXvB,EAW8CC,SAX9C,qBAWwCC,IAXxC;AAYlBC,gBAZkB,GAYLP,WAZK;AAalBZ,cAbkB,GAaP,IAbO;;AActB,UAAGY,gBAAgB,UAAhB,IAAgCG,aAAa,CAAb,IAAkBE,aAAa,CAAlE,EAAuE;AACtEE,oBAAa,mCAAoBX,IAApB,CAAb;AACA;AACD,UAAGI,gBAAgB,QAAnB,EAA4B;AAC3BZ,kBAAW,KAAX;AACA;;AAnBqB;AAAA,aAqBI,eAAKoB,gBAAL,CAAsB;AAC/CC,YAAK,mBAASC,KAAT,CAAeC,QAAf,CAAwBf,KAAKa,GAA7B,CAD0C,EACPR,QAAQ,SADD,EACYb,UAAU;AADtB,OAAtB,EAEvB;AACFwB,aAAM,EAAExB,UAAUA,QAAZ,EAAsBa,QAAQM,UAA9B,EAA0CM,WAAW,uBAArD;AADJ,OAFuB,EAIvB;AACFC,YAAK;AADH,OAJuB,EAMvBzB,QANuB,CAMd,OANc,EAMLA,QANK,CAMI,OANJ,EAMaA,QANb,CAMsB,QANtB,CArBJ;;AAAA;AAqBhB0B,iBArBgB;;AAAA,YA8BnBA,YAAYd,MAAZ,KAAuB,QA9BJ;AAAA;AAAA;AAAA;;AAAA;AAAA,aA+Bf,oBAAUe,MAAV,CAAiB,EAAEC,OAAO,iBAAT,EAA4BC,cAAYH,YAAYN,GAApD,EAA2DR,QAAQ,QAAnE,EAAjB,CA/Be;;AAAA;AAAA,UAmClBb,QAnCkB;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,aA+DjB,oBAAU4B,MAAV,CAAiB,EAAEC,OAAO,4BAAT,EAAuCC,yBAAvC,EAAwDjB,QAAQ,QAAhE,EAAjB,CA/DiB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAAnB;;AAAA;AAAA;AAAA;AAAA,GAAN;kBAkEejB,gB","file":"index.js","sourcesContent":["\nimport _ from 'lodash';\nimport moment from 'moment';\nimport Pick from '../../models/Pick';\nimport SystemLog from '../../models/SystemLog';\nimport mongoose from 'mongoose';\nimport determinePickResult from '../../utils/functions/determinePickResult';\nimport config from '../../config'\n// import apnProvider from '../../apn'\n// import apn from 'apn'\n\n\nconst updatePickResult = async () => {\n\t// eslint-disable-next-line\n\tconsole.log('update pick result')\n\ttry {\n\t\tconst picks = await Pick.find({ isClosed: false }, 'Event marked')\n\t\t\t.populate({ path: 'Event', select: 'isFinished sport score status' })\n\t\t\t.then(picks => _.compact(picks.map(pick => pick.Event.isFinished ? pick : null)) );\n\n \t\tif(_.isEmpty(picks)) return;\n\n\t\tfor( let pick of picks ){\n\t\t\tlet { Event: { status: eventStatus, score: { home: homeScore, away: awayScore } }} = pick;\n\t\t\tlet pickStatus = eventStatus;\n\t\t\tlet isClosed = true;\n\t\t\tif(eventStatus === 'Finished' && ( homeScore >= 0 && awayScore >= 0 )) {\n\t\t\t\tpickStatus = determinePickResult(pick);\n\t\t\t}\n\t\t\tif(eventStatus === 'Review'){\n\t\t\t\tisClosed = false;\n\t\t\t}\n\n\t\t\tconst updatedPick = await Pick.findOneAndUpdate({ \n\t\t\t\t_id: mongoose.Types.ObjectId(pick._id), status: 'Pending', isClosed: false \n\t\t\t}, {\n\t\t\t\t$set: { isClosed: isClosed, status: pickStatus, updatedAt: moment() } \n\t\t\t}, {\n\t\t\t\tnew: true \n\t\t\t}).populate('Event').populate('Agent').populate('Player');\n\n\n\t\t\tif(updatedPick.status === 'Review'){\n\t\t\t\tawait SystemLog.create({ title: 'Pick has Review', content: `${updatedPick._id}`, status: 'danger'});\n\t\t\t}\n\n\n\t\t\tif(!isClosed) continue\n\n\t\t\t// if(updatedPick.Agent.notification.afterPick){\n\t\t\t// \tconst agentNotify = new apn.Notification({\n\t\t\t// \t\tsound: 'ping.aiff',\n\t\t\t// \t\talert: `${updatedPick.Player.username}'s Pick had ${updatedPick.status}, ${updatedPick.Event.team.away} vs ${updatedPick.Event.team.home}`,\n\t\t\t// \t\ttopic: config.APN_TOPIC,\n\t\t\t// \t\tpayload: { BetOrder: updatedPick.BetOrder }\n\t\t\t// \t})\n\t\t\t// \tawait apnProvider.send(agentNotify, updatedPick.Agent.notification.deviceToken)\n\t\t\t// }\n\n\t\t\t// if(updatedPick.Player.notification.afterPick){\n\t\t\t// \tconst playerNotify = new apn.Notification({\n\t\t\t// \t\tsound: 'ping.aiff',\n\t\t\t// \t\talert: `Your Pick had ${updatedPick.status}, ${updatedPick.Event.team.away} vs ${updatedPick.Event.team.home}`,\n\t\t\t// \t\ttopic: config.APN_TOPIC,\n\t\t\t// \t\tpayload: { BetOrder: updatedPick.BetOrder }\n\t\t\t// \t})\n\t\t\t// \tawait apnProvider.send(playerNotify, updatedPick.Player.notification.deviceToken)\n\t\t\t// }\n\n\n//\t\t\tapnProvider.shutdown();\n\n\t\t}\n\t\t\n\t} catch (e) {\n\t\tawait SystemLog.create({ title: 'update picks result failed', content: `${e}`, status: 'danger'});\n\t}\n};\nexport default updatePickResult;\n"]}