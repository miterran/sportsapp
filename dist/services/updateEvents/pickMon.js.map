{"version":3,"sources":["../../../src/services/updateEvents/pickMon.js"],"names":["updateEventOddFromPickMon","isActivate","console","log","findOne","name","then","res","options","join","pickMonSport","get","pickMon_UID","pickMon_Key","data","pickMonXML","explicitArray","hasOwnProperty","lines","game","pickMonEvents","isEmpty","event","theSport","sporttype","includes","thePeriod","line","perioddesc","theMatchTime","utc","gamedate","add","endOf","isBefore","theOddCutOffTime","wagercutoff","isAfter","theLeague","sportsubtype","theAwayPitcher","team1","pitcher","theHomePitcher","team2","theOddCutOffAt","theExpectSecondHalfTime","isSecondHalfOnTime","theSpreadPoint","Number","spread","points","isSpreadPointPositive","theHomeSpreadPoint","theAwaySpreadPoint","Math","abs","theAwayROT","rotnum","toString","theHomeROT","theUniqueID","format","replace","awayLogo","split","toLowerCase","team","sport","league","region","detail","homeLogo","folderName","awayLogoExists","findOneAndUpdate","upsert","homeLogoExists","newEvent","ID","id","uniqueID","provider","bookmaker","period","matchTime","away","awayROT","awayPitcher","home","homeROT","homePitcher","score","odd","awayMoneyLine","money","awaySpreadPoint","awaySpreadLine","homeMoneyLine","homeSpreadPoint","homeSpreadLine","totalOverPoint","total","totalOverLine","over","totalUnderPoint","totalUnderLine","under","drawLine","draw","cutOffAt","isFinished","status","updatedAt","create","title","content"],"mappings":"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","file":"pickMon.js","sourcesContent":["import config from '../../config';\nimport Event from '../../models/Event';\nimport _ from 'lodash';\nimport xml2js from'xml2js-es6-promise';\nimport axios from 'axios';\nimport moment from 'moment';\nimport renameEventPeriod from '../../utils/functions/renameEventPeriod';\nimport renameLeague from '../../utils/functions/renameLeague';\nimport sportTypes from '../../utils/lists/sportTypes';\nimport Provider from '../../models/Provider';\nimport SystemLog from '../../models/SystemLog';\nimport LogoCollect from '../../models/LogoCollect';\nimport { dirname } from '../../index';\nimport fileExists from 'file-exists';\n\nconst updateEventOddFromPickMon = async () => {\n\ttry {\n\t\t\n\t\tif(!await Provider.isActivate('pm')) return; \n\t\t// eslint-disable-next-line\n\t\tconsole.log('update pickMon odd');\n\t\tconst pickMonSport = await Provider.findOne({ name: 'pm' }).then(res => res.options.join(','));\n\t\tconst pickMonXML = await axios.get(`https://api.pickmonitor.com/lines.php?uid=${config.pickMon_UID}&key=${config.pickMon_Key}&sports=${pickMonSport}&graded=0&full_call=1`).then(res => res.data);\n\t\tconst pickMonEvents = await xml2js(pickMonXML, {explicitArray: false}).then(res => (res.hasOwnProperty('lines') && res.lines.hasOwnProperty('game')) ? res.lines.game : [] );\n\t\tif(_.isEmpty(pickMonEvents)) {\n\t\t\t// pm expired need to send notification !!\n\t\t\treturn;\n\t\t}\n\t\tfor( let event of pickMonEvents ) {\n\t\t\tconst theSport = event.sporttype; \n\t\t\tif(!sportTypes.includes(theSport)) continue;\n\t\t\tconst thePeriod = renameEventPeriod(event.line.perioddesc); \n\t\t\tif(thePeriod === 'unknow') continue;\n\t\t\tif(thePeriod !== 'Second Half') continue;\n\t\t\t\n\t\t\tconst theMatchTime = moment.utc(event.gamedate).add(5, 'h'); if(moment().add(5, 'd').endOf('day').isBefore(theMatchTime)) continue;\n\t\t\tconst theOddCutOffTime = moment.utc(event.line.wagercutoff).add(5, 'h'); \n\t\t\tif(moment().isAfter(theOddCutOffTime)) continue;\n\t\t\t\n\t\t\tif(moment().add(1, 'h').isBefore(theOddCutOffTime)) continue;\n\n\t\t\tconst theLeague = renameLeague(theSport, event.sportsubtype);\n\t\t\tconst theAwayPitcher = theSport === 'Baseball' ? (!_.isEmpty(event.team1.pitcher) ? event.team1.pitcher : 'Action') : null;\n\t\t\tconst theHomePitcher = theSport === 'Baseball' ? (!_.isEmpty(event.team2.pitcher) ? event.team2.pitcher : 'Action') : null;\n\t\t\tlet theOddCutOffAt = theOddCutOffTime;\n\t\t\tif(thePeriod === 'Second Half'){ \n\t\t\t\tconst theExpectSecondHalfTime = moment(theMatchTime).add(1, 'h').add(45, 'm');\n\t\t\t\tconst isSecondHalfOnTime = moment(theExpectSecondHalfTime).isAfter(theOddCutOffTime); // return true: Yes its onTime. false: use expect time\n\t\t\t\ttheOddCutOffAt = isSecondHalfOnTime ? theOddCutOffTime : theExpectSecondHalfTime;\n\t\t\t}\n\t\t\tconst theSpreadPoint = Number(event.line.spread.points);\n\t\t\tconst isSpreadPointPositive = theSpreadPoint > 0;\n\t\t\tconst theHomeSpreadPoint = theSpreadPoint;\n\t\t\tconst theAwaySpreadPoint = isSpreadPointPositive ? -Number(theSpreadPoint) : Math.abs(theSpreadPoint);\n\t\t\tconst theAwayROT = event.team1.rotnum.toString();\n\t\t\tconst theHomeROT = event.team2.rotnum.toString();\n\t\t\tconst theUniqueID = `${moment(theMatchTime).format('MMDDYY')}_${theAwayROT}_${theHomeROT}_${theSport}_${thePeriod.replace(/\\s/g,'')}`;\n\t\t\t\n\t\t\t//\n\t\t\tconst awayLogo = {\n\t\t\t\tname: event.team1.name.split(' ').join('_').toLowerCase().replace(/\\.|\\'|\\&/g, ''),\n\t\t\t\tteam: event.team1.name,\n\t\t\t\tsport: theSport,\n\t\t\t\tleague: theLeague,\n\t\t\t\tregion: null,\n\t\t\t\tdetail: `${event.team1.name} ${theAwayROT} vs ${event.team2.name} ${theHomeROT}`\n\t\t\t};\n\t\t\tconst homeLogo = {\n\t\t\t\tname: event.team2.name.split(' ').join('_').toLowerCase().replace(/\\.|\\'|\\&/g, ''),\n\t\t\t\tteam: event.team2.name,\n\t\t\t\tsport: theSport,\n\t\t\t\tleague: theLeague,\n\t\t\t\tregion: null,\n\t\t\t\tdetail: `${event.team1.name} ${theAwayROT} vs ${event.team2.name} ${theHomeROT}`\n\t\t\t};\n\n\t\t\tconst folderName = (theLeague === 'NCAAB' || theLeague === 'NCAAF') ? 'NCAA' : theSport;\n\n\t\t\tconst awayLogoExists = await fileExists(dirname + `/public/images/teamlogos/${folderName}/${awayLogo.name}.png`);\n\t\t\tif(!awayLogoExists) { await LogoCollect.findOneAndUpdate({ name: awayLogo.name }, awayLogo, { upsert: true }); }\n\t\t\tconst homeLogoExists = await fileExists(dirname + `/public/images/teamlogos/${folderName}/${homeLogo.name}.png`);\n\t\t\tif(!homeLogoExists) { await LogoCollect.findOneAndUpdate({ name: homeLogo.name }, homeLogo, { upsert: true }); }\n\t\t\t//\n\n\t\t\tlet newEvent = {\n\t\t\t\tID: event.id,\n\t\t\t\tuniqueID: theUniqueID,\n\t\t\t\tprovider: 'pm',\n\t\t\t\tbookmaker: 'pm',\n\t\t\t\tsport: theSport,\n\t\t\t\tperiod: thePeriod,\n\t\t\t\tleague: theLeague,\n\t\t\t\tregion: null,\n\t\t\t\tmatchTime: moment(theMatchTime),\n\t\t\t\tteam: {\n\t\t\t\t\taway: event.team1.name,\n\t\t\t\t\tawayROT: theAwayROT,\n\t\t\t\t\tawayPitcher: theAwayPitcher,\n\t\t\t\t\thome: event.team2.name,\n\t\t\t\t\thomeROT: theHomeROT,\n\t\t\t\t\thomePitcher: theHomePitcher,\n\t\t\t\t},\n\t\t\t\tscore: {\n\t\t\t\t\thome: null,\n\t\t\t\t\taway: null,\n\t\t\t\t},\n\t\t\t\todd: {\n\t\t\t\t\tawayMoneyLine: Number(event.line.money.team1) || null,\n\t\t\t\t\tawaySpreadPoint: Number(theAwaySpreadPoint) || null,\n\t\t\t\t\tawaySpreadLine: Number(event.line.spread.team1) || null,\n\t\t\t\t\thomeMoneyLine: Number(event.line.money.team2) || null,\n\t\t\t\t\thomeSpreadPoint: Number(theHomeSpreadPoint) || null,\n\t\t\t\t\thomeSpreadLine: Number(event.line.spread.team2) || null,\n\t\t\t\t\ttotalOverPoint: Number(event.line.total.points) || null,\n\t\t\t\t\ttotalOverLine: Number(event.line.total.over) || null,\n\t\t\t\t\ttotalUnderPoint: Number(event.line.total.points) || null,\n\t\t\t\t\ttotalUnderLine: Number(event.line.total.under) || null,\n\t\t\t\t\tdrawLine: Number(event.line.money.draw) || null,\n\t\t\t\t\t\n\t\t\t\t},\n\t\t\t\tcutOffAt: moment(theOddCutOffAt),\n\t\t\t\tisFinished: false,\n\t\t\t\tstatus: 'Pending',\n\t\t\t\tupdatedAt: moment(),\n\t\t\t};\n\t\t\tawait Event.findOneAndUpdate({ uniqueID: newEvent.uniqueID, status: 'Pending' }, newEvent, { upsert: true });\n\t\t}\n\t} catch (e) {\n\t\tawait SystemLog.create({ title: 'update pick mon event failed', content: `${e}`, status: 'danger'});\n\t}\n\n};\n\nexport default updateEventOddFromPickMon;"]}