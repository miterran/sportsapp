{"version":3,"sources":["../../src/middleware/addUserToReq.js"],"names":["addUserToReq","req","res","next","headers","hasOwnProperty","user","_id","username","role","createdAt","token","decodeToken","verify","jwtSecret","findOneAndUpdate","Types","ObjectId","$set","lastOnlineAt","pick"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AAEA,IAAMA;AAAA,oEAAe,iBAAOC,GAAP,EAAYC,GAAZ,EAAiBC,IAAjB;AAAA;AAAA;AAAA;AAAA;AAAA;AACpB,UAAG,CAACF,IAAIG,OAAL,IAAgB,CAACH,IAAIG,OAAJ,CAAYC,cAAZ,CAA2B,eAA3B,CAApB,EAAiE;AAChEJ,WAAIK,IAAJ,GAAW,EAAEC,KAAK,EAAP,EAAWC,UAAU,EAArB,EAAyBC,MAAM,OAA/B,EAAwCC,WAAW,uBAAnD,EAAX;AACAP;AACA;AACKQ,WALc,GAKNV,IAAIG,OAAJ,CAAY,eAAZ,CALM;AAAA;AAObQ,iBAPa,GAOC,uBAAIC,MAAJ,CAAWF,KAAX,EAAkB,iBAAOG,SAAzB,CAPD;AAAA;AAAA,aAQA,eAAKC,gBAAL,CAAsB,EAAER,KAAK,mBAASS,KAAT,CAAeC,QAAf,CAAwBL,YAAYL,GAApC,CAAP,EAAtB,EAAyE,EAACW,MAAM,EAAEC,cAAc,uBAAhB,EAAP,EAAzE,CARA;;AAAA;AAQbb,UARa;;AASnBL,UAAIK,IAAJ,GAAW,iBAAEc,IAAF,CAAOd,IAAP,EAAa,CAAC,KAAD,EAAQ,UAAR,EAAoB,MAApB,EAA4B,WAA5B,CAAb,CAAX;AACAH;AAVmB;AAAA;;AAAA;AAAA;AAAA;;AAYnBF,UAAIK,IAAJ,GAAW,EAAEC,KAAK,EAAP,EAAWC,UAAU,EAArB,EAAyBC,MAAM,OAA/B,EAAwCC,WAAW,uBAAnD,EAAX;AACAP;;AAbmB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAAf;;AAAA;AAAA;AAAA;AAAA,GAAN;;kBAiBeH,Y","file":"addUserToReq.js","sourcesContent":["import mongoose from 'mongoose';\nimport jwt from 'jsonwebtoken';\nimport moment from 'moment';\nimport config from '../config';\nimport User from '../models/User';\nimport _ from 'lodash';\n\nconst addUserToReq = async (req, res, next) => {\n\tif(!req.headers || !req.headers.hasOwnProperty('authorization')) {\n\t\treq.user = { _id: '', username: '', role: 'Guest', createdAt: moment() };\n\t\tnext();\n\t}\n\tconst token = req.headers['authorization'];\n\ttry {\n\t\tconst decodeToken = jwt.verify(token, config.jwtSecret);\n\t\tconst user = await User.findOneAndUpdate({ _id: mongoose.Types.ObjectId(decodeToken._id) }, {$set: { lastOnlineAt: moment() }});\n\t\treq.user = _.pick(user, ['_id', 'username', 'role', 'createdAt']);\n\t\tnext();\n\t} catch (e) {\n\t\treq.user = { _id: '', username: '', role: 'Error', createdAt: moment() };\n\t\tnext();\n\t}\n};\n\nexport default addUserToReq;"]}